var report_tabs="";
var report_tab_contents=""; 
var tab_id=0;
var current_tab=0;

function build_report(report_string) {
    var report = "";
    
    try {
        report =JSON.parse(report_string);
    }
    catch(e) {
        let li = report_string.lastIndexOf("&apos;");
        report_string = report_string.substring(0, li) + '"' + report_string.substring(li + 6);

        report = JSON.parse(report_string);
    }

    if (report.hasOwnProperty("novel")) {
        buildTab(buildNovelReport());
    }
    else if (report.viable=="no") {
        if (report.hasOwnProperty("cost") && report.cost.hasOwnProperty("viable") && report.cost.viable.hasOwnProperty("evaluatedString")) {
            buildTab(buildNonViableReport(report.cost.viable.evaluatedString, report.cost.viable.explanation));
        }
        else if (report.hasOwnProperty("marketing") && report.marketing.hasOwnProperty("viable") && report.marketing.viable.hasOwnProperty("evaluatedString")) {
            buildTab(buildNonViableReport(report.marketing.viable.evaluatedString, report.marketing.viable.explanation));
        }
        else if (report.hasOwnProperty("uniqueFeature") && report.uniqueFeature.hasOwnProperty("viable") && report.uniqueFeature.viable.hasOwnProperty("evaluatedString")) {
            buildTab(buildNonViableReport(report.uniqueFeature.viable.evaluatedString, report.uniqueFeature.viable.explanation));
        }
        else {
            buildTab(buildNonViableReport("Product: "+report.summary.product, report.explanation));
        }

    }
    else {

        buildTab(buildSummary(report));
        buildTab(buildBreakdown(report));
        buildTab(buildGrowthCompetitors(report.expectedGrowth, report.competitors));
        buildTab(buildUniqueFeature(report));
        buildTab(buildCosts(report));
        buildTab(buildMarketing(report));
        buildTab(buildRisks(report));

    }

    let dt = new Date(report.created);
    doAffiliateCode();

    return  "<div class='tabbank'>"+this.report_tabs+"<div class='socials'>"+generateSocials(report)+"</div><div class='clear'></div></div>"+
            "<div class='tabcontents'>"+this.report_tab_contents+"<div class='clear'></div></div>"+
            "<div class='run'><span style='font-style:italic;'>Report Created: "+dt.getFullYear()+"-"+(dt.getMonth()+1)+"-"+dt.getDate()+"</span> [Reports are time-sensitive!]</div>"+
            "<div class='run'>Vet My Idea reports are generated by AI, may be factually incorrect, and are not advice of <em>any kind</em>. Use at your own risk!<br />"+
            "By using this report, you agree to our <a href='https://vetmyidea.biz/terms'>Terms of Service</a> and <a href='https://vetmyidez.biz/privacy'>Privacy Policy</a></div>";
}

function buildTab(tab_input) {
    if (tab_input!==null) {
        let selected="";
        if (tab_input.id===0) {
            selected=" selected";
        }

        this.report_tabs+="<button class='tab"+selected+"' id='tabheader"+tab_input.id+"' style='width:"+tab_input.width+"' onclick='selectTab(\""+tab_input.id+"\")'>"+tab_input.svg+"&nbsp;"+tab_input.name+"</button>";
        this.report_tab_contents+=tab_input.contents;
    }
}

function buildBreakdown(report) {
    let breakdown =   
    "<section id='tab"+tab_id+"' style='display:none;float:left;width:78vw;'>" +
        "<div class='section'>"+
          "<h3>Score Breakdown</h3>";



    breakdown+="<p><b>Base Score:</b> 50</p><p>Each report starts at 50 and can go up to 100 or as low as 0</p>";

    if (!report.summary.hadUniqueFeature && report.competitors.length>3) {
        
        breakdown+="<p style='margin-top:25px;'><b>Insufficient/Ineffective Differentiation:</b> "+scoreStyle(-30)+"</p>";
        breakdown+="<p>The specified differentiation strategies were evaluated to be insufficient or none were provided. Without effective differentiation, there is nothing to make your product/service stand out from the competition."+ 
        "<p>You can score higher by picking a new differentiator and re-running the report.</p>";

    }

    if (report.expectedGrowth.score!==0) {
        breakdown+="<p style='margin-top:25px;'><b>Potential Growth:</b> "+scoreStyle(report.expectedGrowth.score)+"</p>";
    }
    if (report.uniqueFeature && report.uniqueFeature.score!==0) {
        breakdown+="<p style='margin-top:25px;'><b>Unique Feature:</b> "+scoreStyle(report.uniqueFeature.score)+"</p>";
    }
    if (report.cost && report.cost.score!==0) {
        breakdown+="<p style='margin-top:25px;'><b>Reduced Cost:</b> "+scoreStyle(report.cost.score)+"</p>";
    }
    if (report.marketing && report.marketing.score!==0) {
        breakdown+="<p style='margin-top:25px;'><b>Marketing Strategy:</b> "+scoreStyle(report.marketing.score)+"</p>";
    }
    if (report.regulatoryRisk.score!==0) {
        breakdown+="<p style='margin-top:25px;'><b>Regulatory Risk:</b> "+scoreStyle(report.regulatoryRisk.score)+"</p>";
    }
   
    breakdown += "<hr />";
    breakdown+="<p><b>Total Score:</b> "+report.summary.score+"</p>";


    breakdown += "</div></section>";

    let breakdown_result={
        name: "Breakdown",
        contents: breakdown,
        id: tab_id,
        width: "150px",
        svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" /></svg>'
    };

    tab_id++;

    return breakdown_result;

}

function buildCosts(report) {
    if (report.cost) {
        let contents =   
            "<section id='tab"+tab_id+"' style='display:none;float:left;width:78vw;'>" +
                "<div class='section'>";
        
        if (report.cost) {
            contents+="<h3>Reduced Cost "+scoreStyle(report.cost.score)+"</h3>";
            contents+="<p><b>Plan</b>: "+report.cost.evaluatedString+"</p>"
            contents+="<p>"+report.cost.benefits+"</p>";
        }

        contents += "</div></section>";

        let cost_result={
            name: "Cost",
            contents: contents,
            id: tab_id,
            width: "110px",
            svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg>'
        };
    
        tab_id++;
    
        return cost_result;

    }
    else {
        return null;
    }
}

function buildMarketing(report) {
    if (report.marketing) {
        let contents =   
            "<section id='tab"+tab_id+"' style='display:none;float:left;width:78vw;'>" +
                "<div class='section'>";
        
        if (report.marketing) {
            contents+="<h3>Marketing Strategy "+scoreStyle(report.marketing.score)+"</h3>";
            contents+="<p><b>Plan</b>: "+report.marketing.evaluatedString+"</p>"
            contents+="<p>"+report.marketing.benefits+"</p>";
        }

        contents += "</div></section>";

        let mkt_result={
            name: "Marketing",
            contents: contents,
            id: tab_id,
            width: "135px",
            svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" /></svg>'
        };
    
        tab_id++;
    
        return mkt_result;

    }
    else {
        return null;
    }
}

function buildNonViableReport(strategy,explanation) {
    let contents =   
    "<section id='tab"+tab_id+"' style='float:left;width:78vw;'>" +
      "<div class='section'>"+
        "<h2>Potentially Non-Viable Idea</h2>"+
        "<p>We found one or more arguments that your stated strategy: '"+strategy+"' is non-viable. These are in the paragraph below this one:</p>"+
        "<p>&quot;"+explanation+"&quot;</p>"+
        "<p><b>Warning</b>: <em>You should independently verify the correctness of these arguments</em></p>"+
        "<p>Potentially non-viable ideas are not scored</p>"+
      "</div>"+
      "</section>"; 

    let nonviable_result={
        name: "Summary",
        contents: contents,
        id: tab_id,
        width: "150px",
        svg: ''
    };

    tab_id++;

    return nonviable_result;
}

function buildNovelReport() {
    let contents =   
    "<section id='tab"+tab_id+"' style='float:left;width:78vw;'>" +
      "<div class='section'>"+
        "<h2>No Competition</h2>"+
        "<p>We did not find any competitors for the product/service you specified. This could be because:</p>"+
        "<p>1. We did not detect competing businesses in the target location you provided<br />"+
        "2. The idea is novel</p>"+
        "<p>As competition analysis is a key aspect of our evaluation process, we cannot compile reports for items with this classification. "+
        "If you believe you received this classification in error, then double check that the product and target location are correct on the My Reports dashboard</p>"+
      "</div>"+
      "</section>"; 

    let novel_result={
        name: "Summary",
        contents: contents,
        id: tab_id,
        width: "150px",
        svg: ''
    };

    tab_id++;

    return novel_result;
}

function buildRisks(report) {
    let contents =   
    "<section id='tab"+tab_id+"' style='display:none;float:left;width:78vw;'>" +
        "<div class='section'><h3>Regulatory Risk: "+sanitize(report.regulatoryRisk.risk.toUpperCase())+" "+scoreStyle(report.regulatoryRisk.score)+"</h3>"+
        "<p>"+sanitize(report.regulatoryRisk.explanation)+"</p>";

    contents += "</div></section>";

    let risk_result={
        name: "Regulatory Risk",
        contents: contents,
        id: tab_id,
        width: "175px",
        svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>'
    };

    tab_id++;

    return risk_result;   
}

function buildSummary(report) {

    let bordercolor="#444";
    if (report.summary.score>64) {
        bordercolor="green";
    }
    if (report.summary.score>80) {
        bordercolor="darkgreen";
    }
    if (report.summary.score<36) {
        bordercolor="red";
    }
    if (report.summary.score<20) {
        bordercolor="#8B0000";
    }

    let contents =   
      "<section id='tab"+tab_id+"' style='float:left;width:78vw;'>" +
        "<div class='section'>"; 

    contents += "<div class='summaryRight'>";
    contents += "<h3 class='scoreHeader summaryHeader' style='margin-top:1.5rem;'>VetMyIdea Score</h3><div class='circle-score' style='border: 3.6rem solid "+bordercolor+";'><div class='values'>"+report.summary.score+"</div><div class='labels'>"+sanitize(report.summary.scoremeaning)+"</div></div>";
    contents += "<p><a href='#' onclick='selectTab(1)'>Detailed Score Breakdown</a></p>";
    contents += "</div>";

    contents += "<div class='summaryLeft'>";

    contents += "<h3 class='productTitle summaryHeader' style='margin-top:1.5rem;'>Product/Service &amp; Targeted Location</h3><p><em>"+this.sanitize(report.summary.title)+"</em></p>";
    
    contents += "<h3 style='margin-top:4.5rem;' class='summaryHeader'>How To Use This Report</h3>"+
        "<p><b>Understanding the Score</b><br />Click on the <a href='#' onclick='selectTab(1)'>score breakdown tab</a> to get further details about how the score was calculated and what it means</p>"+
        "<p><b>Detailed Analysis</b><br />Click each tab at the top of the report (desktop) or scroll down (mobile) to get detailed input on different aspects of your idea</p>"+
        "<p><b>Re-running the Report</b><br />If you'd like to change your answers, you can re-run this report by clicking the Edit (pencil) button on the My Reports dashboard. [Note: you cannot change the product/service or the location - you'll need to run a new report]</p>"+
        "<p><b>Additional Research</b><br />You may wish to do further research on your idea. Our partners can assist you with this.</p>"+
        "<p><b>Moving Forward</b><br />Should you decide to move forward, our partners can help you get your business off the ground.</p>"

    contents += "</div>"

    contents += "<div class='clear'></div>";
    contents += "</div></section>";

    let summary_result={
        name: "Summary",
        contents: contents,
        id: tab_id,
        width: "125px",
        svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25M9 16.5v.75m3-3v3M15 12v5.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'
    };

    tab_id++;

    return summary_result;
}

function buildGrowthCompetitors(growth, competitors) {

    let competition = "<h3>Potential Competitors</h3><p><em>This list may be incomplete!</em></p><p>";

    for (n=0; n<competitors.length; n++) {
        competition+=(n+1)+". "+sanitize(competitors[n])+"<br />";
    }

    competition+="</p>";

    let growth_result={
        name: "Growth",
        contents: "<section id='tab"+tab_id+"' style='display:none;float:left;width:78vw;'><div class='section'><h3>Growth Potential: "+sanitize(growth.growth.toUpperCase()) + " "+scoreStyle(growth.score)+"</h3>"+
            "<p style='margin-bottom:30px;'>"+sanitize(growth.explanation)+"</p>"+competition+"</div></section>",
        id: tab_id,
        width:"110px",
        svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" /></svg>'
    };

    tab_id++;

    return growth_result;
}

function buildUniqueFeature(report) {
    if (report.uniqueFeature) {
        let contents =   
            "<section id='tab"+tab_id+"' style='display:none;float:left;width:78vw;'>" +
                "<div class='section'>";
        
   
        contents+="<h3>Unique Feature "+scoreStyle(report.uniqueFeature.score)+"</h3>";
        contents+="<p><b>Plan</b>: "+report.uniqueFeature.evaluatedString+"</p>"
        contents+="<p>"+report.uniqueFeature.benefits+"</p>";
        

        contents += "</div></section>";

        let cost_result={
            name: "Unique Feature",
            contents: contents,
            id: tab_id,
            width: "175px",
            svg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" style="vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" /></svg>'
        };
    
        tab_id++;
    
        return cost_result;

    }
    else {
        return null;
    }
}

function doAffiliateCode() {
    this.report_tab_contents+= "<section id='tab"+tab_id+"' style='float:right;text-center;width:19vw;'><div style='text-align:center;margin-top:25px;'>Links To Our Partners</div><br /></section>";
}

function generateSocials(report) {
    if (report.hasOwnProperty("novel")) {
        return ""; 
    }
    else {
        return  '<!--<script type="IN/Share" data-url="'+report.summary.url+'"></script>//-->' +
                '<div id="fb-root"></div>'+
                '<div class="fb-share-button"'+ 
                'data-href="'+report.summary.url+'"'+
                'data-layout="button_count">'+
                '</div>'+
                '<a class="twitter-share-button" href="https://twitter.com/intent/tweet">Tweet</a>'
    }
          
}

function sanitize(content) {
    if (typeof(content)==="string") {
        return content.replace(/_/g," ").replace(/[^A-Za-z0-9\.&,;'\s]/g,"");
    }
    return content;
}

function scoreStyle(score) {
    if (typeof(score)==="number") {
        if (score>0) {
            return "(<span style='color:green'>+"+String(score)+"</span>)";
        }
        else if (score<0) {
            return "(<span style='color:red'>"+String(score)+"</span>)";
        }
        else {
            return "";
        }
    }
}

function selectTab(id) {
    let curr_tab_header = document.getElementById("tabheader"+current_tab);
    let new_tab_header = document.getElementById("tabheader"+id);
    curr_tab_header.classList.remove("selected");
    new_tab_header.classList.add("selected");
    let curr_tab = document.getElementById("tab"+current_tab);
    let new_tab = document.getElementById("tab"+id);
    curr_tab.style="display:none;float:left;width:78vw;";
    new_tab.style="display:block;float:left;width:78vw;";
    current_tab=id;

}